services:
  # PostgreSQL database with pgvector extension
  postgres:
    image: pgvector/pgvector:pg16
    container_name: cg_postgres
    environment:
      POSTGRES_USER: cguser
      POSTGRES_PASSWORD: cgpass
      POSTGRES_DB: cg_metadata
    ports:
      - "5432:5432"
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
      - ./init_pgvector.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U cguser" ]
      interval: 5s
      timeout: 5s
      retries: 5

  metadata-extractor:
    build: .
    container_name: cg_metadata_extractor
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      # Mount your data directory (read-only) - for local development only
      - ./data:/data:ro
      # Mount output directory for reports and thumbnails
      - ./output:/app/output
      # Mount model cache to avoid re-downloading on each build
      - model_cache:/root/.cache/huggingface
    environment:
      # Storage configuration
      - STORAGE_TYPE=local # Change to 's3' for AWS deployment

      # Local storage path (used when STORAGE_TYPE=local)
      - DATA_PATH=/data

      # S3 configuration (used when STORAGE_TYPE=s3)
      # - ASSET_BUCKET_NAME=your-asset-bucket-name
      # - S3_PREFIX=production-files/
      # - THUMBNAIL_BUCKET_NAME=your-thumbnail-bucket-name
      # - AWS_REGION=us-east-1
      # Note: AWS credentials should be provided via IAM roles in AWS Batch

      # Database configuration - PostgreSQL with pgvector
      - DATABASE_URL=postgresql://cguser:cgpass@postgres:5432/cg_metadata

      # For SQLite (legacy), use:
      # - DATABASE_URL=sqlite:///./db/metadata.db

      # Logging
      - LOG_LEVEL=INFO

volumes:
  model_cache:
